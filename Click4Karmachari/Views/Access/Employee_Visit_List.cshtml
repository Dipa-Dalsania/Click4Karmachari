@using ClickKarmachari;
@{
    ViewBag.Title = "Employee_Visit_List";
    Layout = "~/Views/Access/Access_Layout.cshtml";
    List<User_Visits> visit = ViewBag.v ?? new List<User_Visits>();

    List<UserMaster> user = ViewBag.user ?? new List<UserMaster>();

    DateTime dt = DateTime.Now;
    List<string> vstr = ViewBag.Visited_Str;
    string visited_dt = dt.ToString("dd MMMM yyyy");
    string name = ViewBag.u_name;
    string visited = ViewBag.Visited_Str1;
}
@*AIzaSyDyQus3O5qcFbJMPPScNtdmUglz9X2-XrA*@



@*<style>
/*    .form-control,
    .form-select {
        height: 45px;
        border-radius: 6px;
    }*/

    .select2-container .select2-selection--single {
        height: 45px !important;
        padding: 6px 12px;
    }

    .select2-container--default .select2-selection--single .select2-selection__rendered {
        line-height: 32px;
    }

</style>*@
<!--Page header-->
<div class="page-header d-xl-flex d-block">
    <div class="page-leftheader">
        <h4 class="page-title">All Visit</h4>
    </div>
</div>
<!--End Page header-->

<div class="row">
    <div class="col-xl-12 col-md-12 col-lg-12">
        <div class="card">
            <!--<div class="card-header  border-0">
        <h4 class="card-title">-->
            @*Visit List*@
            <!--</h4>
    </div>-->
            <div class="card shadow-sm border-1 mb-4" style="border-color: #e9ecef;">

                <div class="card-header bg-white py-3 border-bottom-0">
                    <h5 class="mb-0 fw-bold text-primary">
                        <i class="bi bi-funnel-fill me-2"></i>Filter Data
                    </h5>
                </div>

                <div class="card-body p-4">
                    <form>
                        <div class="row g-3 align-items-end">

                            <div class="col-md-4">
                                <label for="Emp_Id" class="form-label text-muted small text-uppercase fw-bold">
                                    Select Employee <span class="text-danger">*</span>
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text bg-light text-secondary"><i class="bi bi-person-fill"></i></span>
                                    <select name="Emp_Id" id="Emp_Id" class="form-select select2-show-search" required>
                                        <option value="" selected disabled>-- Choose Employee --</option>
                                        @foreach (UserMaster _c in user)
                                        {
                                            <option value="@_c.User_ID">@_c.User_Name</option>
                                        }
                                    </select>
                                </div>
                            </div>

                            <div class="col-md-3">
                                <label for="FromDate" class="form-label text-muted small text-uppercase fw-bold">
                                    From Date <span class="text-danger">*</span>
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text bg-light text-secondary"><i class="bi bi-calendar-event"></i></span>
                                    <input type="date" name="FromDate" id="FromDate" class="form-control" required />
                                </div>
                            </div>

                            <div class="col-md-3">
                                <label for="ToDate" class="form-label text-muted small text-uppercase fw-bold">
                                    To Date <span class="text-danger">*</span>
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text bg-light text-secondary"><i class="bi bi-calendar-event-fill"></i></span>
                                    <input type="date" name="ToDate" id="ToDate" class="form-control" required />
                                </div>
                            </div>

                            <div class="col-md-2">
                                <label class="form-label d-block">&nbsp;</label>
                                <button type="button" class="btn btn-primary w-100 fw-semibold shadow-sm" onclick="get_data();">
                                    <i class="bi bi-search me-2"></i>Submit
                                </button>
                            </div>

                        </div>
                    </form>
                </div>
            </div>


            <div class="card-body">
                <div class="table-responsive">
                    <table id="visit_data" class="table table-bordered table-hover">
                        <thead>
                            <tr>
                                <th>Punch Name</th>
                                <th>Date</th>
                                <th>Location</th>
                                <th>LocationName</th>
                                <th>IP Address</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (User_Visits _newobj in visit)
                            {

                                <tr>
                                    <td>@_newobj.Punch_Type.Puch_Name</td>
                                    <td>@_newobj.Time.ToString("dd/MM/yyyy hh:mm tt")</td>
                                    <td>@_newobj.Location</td>
                                    <td>@_newobj.LocationName</td>
                                    <td>@_newobj.IP_Address</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-12">
        <div class="card">
            <div class="card-body">
                <div id="divMap" style="width:100%;height:400px;"></div>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">

    function demo(lat, lon, title, desc) {
        var lat = lat;
        var lon = lon;
        var tit = title;
        var des = desc;
        var markers = [];
        for (i = 0; i < lat.length; i++) {
            var str1 = "'";
            var str2 = tit[i];
            var res = str1.concat(str2);
            var res1 = res.concat(str1);

            var strd1 = "'";
            var strd2 = des[i];
            var resd = strd1.concat(strd2);
            var resd1 = resd.concat(strd1);


            markers.push({ title: res1, lat: lat[i], lng: lon[i], description: resd1 });

        }

        var mapOptions = {
            center: new google.maps.LatLng(markers[0].lat, markers[0].lng),
            zoom: 10,
            mapTypeId: google.maps.MapTypeId.ROADMAP
            //  marker:true
        };

        var infoWindow = new google.maps.InfoWindow();
        var map = new google.maps.Map(document.getElementById("divMap"), mapOptions);
        for (i = 0; i < markers.length; i++) {
            var data = markers[i]

            var myLatlng = new google.maps.LatLng(data.lat, data.lng);
            var marker = new google.maps.Marker({
                position: myLatlng,
                map: map,
                title: data.title
            });
            (function (marker, data) {



                // Attaching a click event to the current marker
                google.maps.event.addListener(marker, "click", function (e) {
                    infoWindow.setContent(data.description);
                    infoWindow.open(map, marker);
                });
            })(marker, data);
        }
    }


    function showMap() {
        var markers = [];

        var Emp_Id = document.getElementById("Emp_Id").value;
        var fromDate = document.getElementById("FromDate").value;
        var toDate = document.getElementById("ToDate").value;

        $.ajax({
            type: "POST",
            url: "/Access/GetMap?Emp_Id=" + Emp_Id + "&date=" + Date,
            data: "{}",
            success: function (data) {
                //alert("Get :" + markers);

            },
            error: function (errormessage) {
                alert("invalid input...");
            }
        });

    }


    function googleMap(mark) {
        var markers = mark;
        var mapOptions = {
            center: new google.maps.LatLng(markers[0].lat, markers[0].lng),
            zoom: 8,
            mapTypeId: google.maps.MapTypeId.ROADMAP
        };


        var infoWindow = new google.maps.InfoWindow();
        var map = new google.maps.Map(document.getElementById("divMap"), mapOptions);
        for (i = 0; i < markers.length; i++) {
            var data = markers[i];
            var myLatlng = new google.maps.LatLng(data.lat, data.lng);
            var marker = new google.maps.Marker({
                position: myLatlng,
                map: map,
                title: data.title
            });
            (function (marker, data) {
                // Attaching a click event to the current marker
                google.maps.event.addListener(marker, "click", function (e) {
                    infoWindow.setContent(data.description);
                    infoWindow.open(map, marker);
                });
            })(marker, data);
        }
    }

    //function myMap() {
    //    var markers = document.getElementById("str").value;

    //    const uluru = { lat: 21.7155054, lng: 73.0019352 };
    //    // The map, centered at Uluru
    //    const map = new google.maps.Map(document.getElementById("divMap"), {
    //        zoom: 4,
    //        center: uluru,
    //    });
    //    // The marker, positioned at Uluru
    //    const marker = new google.maps.Marker({
    //        position: uluru,
    //        map: map,
    //    });
    //}

</script>
<script>
    //window.onload = function () {

    //    demo();
    //}
    function get_data() {
        var eid = document.getElementById("Emp_Id").value;
        var fromDate = document.getElementById("FromDate").value;
        var toDate = document.getElementById("ToDate").value;
        $.ajax({
            type: "POST",
            url: "/Access/Get_map_data?eid=" + eid + "&fromDate=" + fromDate + "&toDate=" + toDate,
            data: "{}",
            success: function (data) {
                $("#visit_data tbody").empty();
                var content = '';
                if (data.ErrorTitle == "S") {
                    var lat = data.lati;
                    var lon = data.longi;
                    var pname = data.punchname;
                    var location = data.desc;
                    var locationname = data.tit;
                    var ipaddress = data.ipadd;
                    var dt = data.visitdt;
                    for (i = 0; i < lat.length; i++) {

                        content += '<tr>';
                        content += '<td>' + pname[i] + '</td>';
                        content += '<td>' + dt[i] + '</td>';
                        content += '<td>' + location[i] + '</td>';
                        content += '<td>' + locationname[i] + '</td>';
                        content += '<td>' + ipaddress[i] + '</td>';
                        content += '</tr>';
                    }

                    $("#visit_data tbody").append(content);

                    demo(data.lati, data.longi, data.tit, data.desc);


                }




            },
            error: function () {
                //alert("failure");
            }
        });
    }
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC6v5-2uaq_wusHDktM9ILcqIrlPtnZgEk&sensor&callback=googleMap"></script>




