@using ClickKarmachari;
@{
    ViewBag.Title = "Employee_Punch_List";
    Layout = "~/Views/Access/Access_Layout.cshtml";
    List<User_Punch> user_punch = ViewBag.user_punch;
    List<UserMaster> user = ViewBag.user;
    DateTime dtoday = DateTime.Now;
    string st = dtoday.ToString("dd MMMM yyyy");
    DateTime dt = ViewBag.dt != null
    ? Convert.ToDateTime(ViewBag.dt)
    : DateTime.Now;

    string str = dt.ToString("dd-MM-yyyy");
    string fst = dt.ToString("dd MMMM yyyy");
    string imagepath = "";
}

<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0/dist/js/select2.min.js"></script>



<style>
    .avatar-9-16 {
        width: 40px;
        height: 71px;
        object-fit: cover; /* keeps image properly cropped */
        border-radius: 8px; /* optional, remove if not needed */
    }
</style>



<!--Page header-->
<div class="page-header d-xl-flex d-block">
    <div class="page-leftheader">
        <h4 class="page-title">All Punch</h4>
    </div>
</div>
<!--End Page header-->
<!-- Row -->
<div class="row">
    <div class="col-xl-12 col-md-12 col-lg-12">
        <div class="card">
            <div class="card-header  border-0">
                <h4 class="card-title">@*Punch List*@</h4>
            </div>

            <div class="card-body">
                @using (Html.BeginForm("Employee_Punch_List", "Access", FormMethod.Post, new { @enctype = "multipart/form-data" }))
                {
                    <div class="row align-items-end">

                        <!-- Select Employee -->
                        <div class="col-md-4">
                            <label class="form-label">Select Employee <span class="text-danger">*</span></label>
                            <select name="Emp_Id" id="Emp_Id"
                                    class="form-control select2-show-search custom-select"
                                    required>
                                <option value="-1" selected>All</option>

                                @foreach (UserMaster _c in user)
                                {
                                    <option value="@_c.User_ID">@_c.User_Name</option>
                                }
                            </select>
                        </div>

                        <!-- From Date -->
                        <div class="col-md-3">
                            <label class="form-label">From</label>
                            <input type="date"
                                   name="FromDate"
                                   class="form-control"
                                   value="@(ViewBag.FromDate != null
               ? Convert.ToDateTime(ViewBag.FromDate).ToString("yyyy-MM-dd")
               : DateTime.Now.ToString("yyyy-MM-dd"))"
                                   max="@DateTime.Now.ToString("yyyy-MM-dd")">
                        </div>

                        <!-- To Date -->
                        <div class="col-md-3">
                            <label class="form-label">To</label>
                            <input type="date"
                                   name="ToDate"
                                   class="form-control"
                                   value="@(ViewBag.ToDate != null
               ? Convert.ToDateTime(ViewBag.ToDate).ToString("yyyy-MM-dd")
               : DateTime.Now.ToString("yyyy-MM-dd"))"
                                   max="@DateTime.Now.ToString("yyyy-MM-dd")">
                        </div>

                        <!-- Submit Button -->
                        <div class="col-md-2">
                            <button type="submit" class="btn btn-primary w-100">
                                Submit
                            </button>
                        </div>

                    </div>



                }
                @if (user_punch != null)
                {
                    <br /> <br />
                    if (ViewBag.user_id != -1)
                    {
                        var usersGroupedByCountry = user_punch
                            .OrderBy(x => x.Punch_Id)
                            .GroupBy(x => x.Time.Date);

                        <div class="table-responsive" style="overflow-x:unset !important;">
                            <table class="table table-hover text-nowrap table-striped table-bordered border-bottom">

                                <thead>
                                    <tr>
                                        <th>User Name</th>
                                        <th>Punch Date</th>
                                        <th>Total Time</th>
                                        <th>Punch Time</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var _newobj in usersGroupedByCountry.OrderByDescending(x => x.Key))
                                    {
                                        double hours = 0;
                                        double rounded = 0;

                                        // ✅ Calculate total time BEFORE row print
                                        var time1 = _newobj
                                            .Where(x => x.PunchType_Id == 1)
                                            .OrderBy(x => x.Time)
                                            .FirstOrDefault();

                                        var time2 = _newobj
                                            .Where(x => x.PunchType_Id == 2)
                                            .OrderByDescending(x => x.Time)
                                            .FirstOrDefault();

                                        if (time1 != null && time2 != null)
                                        {
                                            TimeSpan diff = time2.Time - time1.Time;
                                            hours = diff.TotalHours;
                                            rounded = Math.Floor(hours);
                                        }

                                        <tr>

                                            <td class="form-label" style="text-transform:capitalize">
                                                @_newobj.FirstOrDefault().UserMaster.User_Name
                                            </td>

                                            <!-- Punch Date -->
                                            <td>
                                                @_newobj.FirstOrDefault().Time.ToString("dd MMMM yyyy")
                                            </td>

                                            <!-- ✅ Total Time AFTER Date -->
                                            <td>
                                                @rounded
                                            </td>

                                            <!-- Punch Time -->
                                            @foreach (var punch in _newobj)
                                            {
                                                imagepath = "~/Uploads/Punch_Image/" + punch.image_name;

                                                <td colspan="4">
                                                    <div class="popover-example">
                                                        <a href="@Url.Content(imagepath)" target="_blank">
                                                            @*<img src="~/Uploads/Punch_Image/@punch.image_name"
                                                    onerror="this.src='@Url.Content("~/Uploads/User_Image/profile.jpg")';"
                                                    class="avatar avatar-md brround me-3" />*@
                                                            <img src="~/Uploads/Punch_Image/@punch.image_name"
                                                                 onerror="this.src='@Url.Content("~/Uploads/User_Image/profile.jpg")';"
                                                                 class="avatar-9-16 me-3" />
                                                        </a>
                                                    </div>

                                                    @punch.Punch_Type.Puch_Name ,
                                                    <br />

                                                    <a onclick="Punch_Update(@punch.Punch_Id,'@punch.Time.ToString("yyyy-MM-ddTHH:mm")')" style="color:blue">
                                                        @punch.Time.ToString("hh:mm:ss tt")
                                                    </a>

                                                    <br />
                                                    <b>@punch.IP_Address</b>
                                                </td>
                                            }

                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }

                    else
                    {
                        var usersGroupedByCountry = user_punch
                            .OrderBy(x => x.Punch_Id)
                            .GroupBy(x => new { x.User_Id, Date = x.Time.Date });

                        <div class="table-responsive">
                            <table class="table table-hover text-nowrap">

                                <thead>
                                    <tr>
                                        <th>User Name</th>
                                        <th>Punch Date</th>
                                        <th>Total Time</th>
                                        <th>Punch Time</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var _newobj in usersGroupedByCountry
.OrderByDescending(x => x.Key.Date)
.ThenBy(x => x.Key.User_Id))

                                    {
                                        double hours = 0;
                                        double rounded = 0;

                                        // ✅ Calculate total time BEFORE row print
                                        var time1 = _newobj
                                            .Where(x => x.PunchType_Id == 1)
                                            .OrderBy(x => x.Time)
                                            .FirstOrDefault();

                                        var time2 = _newobj
                                            .Where(x => x.PunchType_Id == 2)
                                            .OrderByDescending(x => x.Time)
                                            .FirstOrDefault();

                                        if (time1 != null && time2 != null)
                                        {
                                            TimeSpan diff = time2.Time - time1.Time;
                                            hours = diff.TotalHours;
                                            rounded = Math.Floor(hours);
                                        }

                                        <tr>

                                            <td class="form-label" style="text-transform:capitalize">
                                                @_newobj.FirstOrDefault().UserMaster.User_Name
                                            </td>

                                            <!-- Punch Date -->
                                            <td>
                                                @_newobj.FirstOrDefault().Time.ToString("dd MMMM yyyy")
                                            </td>

                                            <!-- ✅ Total Time AFTER Date -->
                                            <td>
                                                @rounded
                                            </td>

                                            <!-- Punch Time -->
                                            @foreach (var punch in _newobj)
                                            {
                                                imagepath = "~/Uploads/Punch_Image/" + punch.image_name;

                                                <td colspan="4">
                                                    <div class="popover-example">
                                                        <a href="@Url.Content(imagepath)" target="_blank">
                                                            @* <img src="~/Uploads/Punch_Image/@punch.image_name"
                                                             onerror="this.src='@Url.Content("~/Uploads/User_Image/profile.jpg")';"
                                                             class="avatar avatar-md brround me-3" />
                                                    </a>*@
                                                            <img src="~/Uploads/Punch_Image/@punch.image_name"
                                                                 onerror="this.src='@Url.Content("~/Uploads/User_Image/profile.jpg")';"
                                                                 class="avatar-9-16 me-3" />
                                                    </div>

                                                    @punch.Punch_Type.Puch_Name ,
                                                    <br />

                                                    <a onclick="Punch_Update(@punch.Punch_Id,'@punch.Time.ToString("yyyy-MM-ddTHH:mm")')" style="color:blue">
                                                        @punch.Time.ToString("hh:mm:ss tt")
                                                    </a>

                                                    <br />
                                                    <b>@punch.IP_Address</b>
                                                </td>
                                            }

                                        </tr>
                                    }
                                </tbody>

                            </table>
                        </div>
                    }

                }

            </div>


        </div>
    </div>
</div>

<!-- End Row-->
<!-------------------Update Punch------------------------------------------->
<div class="modal fade" id="Model_Punch_Update" tabindex="-1" role="dialog" aria-hidden="true">
    @using (Ajax.BeginForm("Employee_Punch_Update", "Access", new AjaxOptions { HttpMethod = "POST", OnSuccess = "OnUpdateAdminEmpPunch" }, new { @id = "form", @enctype = "multipart/form-data", role = "form" }))
    {
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Update Punch</h5>
                    <button class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="row">

                        @Html.AntiForgeryToken()
                        <input type="hidden" name="Punch_Id" id="Punch_Id" />
                        <div class="col-lg-6">
                            <label class="form-label">Punch Time</label>
                            <div class="form-group">
                                <input type="datetime-local" name="Punchdate" id="Punchdate" class="form-control">
                            </div>
                        </div>

                    </div>
                </div>
                <div class="modal-footer modal-new-footer">
                    <button type="button" class="btn btn-light" data-dismiss="modal"><i class="fa fa-close"></i>&ensp;<b style="color:#222222">Close</b></button>
                    <button type="submit" id="savebtn" name="Command" value="Save" class="btn btn-info"><i class="feather feather-save"></i>&ensp;Save</button>
                    <button type="submit" id="deletebtn" name="Command" value="Delete" class="btn btn-danger"><i class="feather feather-trash"></i>&ensp;Delete</button>
                </div>
            </div>
        </div>
    }

    <script>
        $(document).ready(function () {

            function toggleDateFields() {

                var empId = $("#Emp_Id").val();

                console.log("Selected Value:", empId); // Debug

                /*    if (empId == "-1") {
                        // All selected
                        $("#singleDateDiv").show();
                        $("#dateRangeDiv").hide();
                    } else {
                        // User selected
                        $("#singleDateDiv").hide();
                        $("#dateRangeDiv").show();
                    }*/
            }

            // Trigger on normal change
            $("#Emp_Id").on("change", function () {
                toggleDateFields();
            });

            // Trigger on select2 change also (IMPORTANT)
            $("#Emp_Id").on("select2:select", function () {
                toggleDateFields();
            });



        });
    </script>

