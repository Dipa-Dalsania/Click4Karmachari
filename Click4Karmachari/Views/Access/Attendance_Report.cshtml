@using ClickKarmachari;
@{
    ViewBag.Title = "Attendance_Report";
    Layout = "~/Views/Access/Access_Layout.cshtml";
    List<Attendance_Master> attendance = ViewBag.attendance;
    List<UserMaster> user = ViewBag.user;
    List<Leave_Master> _leave = ViewBag.leave;
    string m = ViewBag.mm;
    int leavemst = 0;
}
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.2.0/css/datepicker.min.css" rel="stylesheet">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.2.0/js/bootstrap-datepicker.min.js"></script>

<div class="page-header d-xl-flex d-block">
    <div class="page-leftheader">
        <h4 class="page-title">All Attendance Report</h4>
    </div>
</div>
<div class="row">
    <div class="col-xl-12 col-md-12 col-lg-12">
        <div class="card">
            <div class="card-header  border-0">
                <h4 class="card-title">Attendance Report</h4>
            </div>
            <div class="card-body">
                @using (Html.BeginForm("Attendance_Report", "Access", FormMethod.Post, new { @enctype = "multipart/form-data" }))
                {
                    <div class="row align-items-center">

                        <div class="col-md-4">
                            @if (m == "" || m == null)
                            {
                                <input type="text" class="form-control"
                                       placeholder="Select Month"
                                       autocomplete="off"
                                       name="datepicker"
                                       id="datepicker" required />
                            }
                            else
                            {
                                <input type="text" class="form-control"
                                       placeholder="Select Month"
                                       autocomplete="off"
                                       name="datepicker"
                                       id="datepicker"
                                       value="@m" required />
                            }
                        </div>

                        <div class="col-md-2">
                            <button class="btn btn-primary w-100" type="submit">
                                <strong>Submit</strong>
                            </button>
                        </div>

                        <div class="col-md-3">
                            <a onclick="onDownload()" id="download" class="btn btn-info w-100">
                                <i class="fa fa-download"></i>
                                <span class="ms-2">Download UsePunch</span>
                            </a>
                        </div>

                    </div>
                }
            </div>


            <div class="card-body">
                @if (attendance != null)
                {

                    <div class="col-xl-9 col-md-9 col-lg-9">
                        <div class="card">
                            <div class="card-header  border-0">
                                <h4 class="card-title atten-text">Attendance Report For <strong style="color:crimson;">[ @ViewBag.mm - @ViewBag.year ]</strong></h4>
                            </div>
                            <div class="card-body pt-0 pb-3">
                                <div class="row mb-0 pb-0">
                                    <div class="col-md-8 col-xl-4 text-center py-5">
                                        <span class="avatar avatar-md bradius fs-20 bg-primary-transparent">@ViewBag.TotalSundays</span>
                                        <h5 class="mb-0 mt-3">Total Sundays</h5>
                                    </div>
                                    <div class="col-md-8 col-xl-4 text-center py-5 ">
                                        <span class="avatar avatar-md bradius fs-20 bg-success-transparent">@ViewBag.TotalHoliday</span>
                                        <h5 class="mb-0 mt-3">Total Holidays</h5>
                                    </div>
                                    <div class="col-md-8 col-xl-4 text-center py-5">
                                        <span class="avatar avatar-md bradius fs-20 bg-danger-transparent">@ViewBag.WorkingDays</span>
                                        <h5 class="mb-0 mt-3">Total Working Days</h5>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>


                    <br />
                    <br /> <br />
                    <div class="table-responsive">
                        <table id="basic-datatable1" class="table table-striped table-bordered border-bottom table-hover">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Working Days</th>
                                    <th>Present Days</th>
                                    <th>Absent Days</th>
                                    <th>History</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (UserMaster _um in user)
                                {
                                    leavemst = _leave.Where(x => x.User_Id == _um.User_ID).Count();
                                    List<decimal> total_atthours = new List<decimal>();
                                    decimal count = 0;
                                    decimal n = 0;
                                    decimal Absent = 0;
                                    decimal holidays = ViewBag.TotalHoliday;
                                    decimal sundays = ViewBag.TotalSundays;
                                    decimal Workingdays = ViewBag.WorkingDays;
                                    decimal totaldays = ViewBag.totalDays;
                                    decimal absent_leave = 0;


                                    <tr>

                                        <td style="text-transform: capitalize">@_um.User_Name</td>
                                        @foreach (Attendance_Master _newobj in attendance.Where(x => x.User_Id == _um.User_ID))
                                        {
                                            if (_newobj.Attendance == Convert.ToDecimal(0.5) || _newobj.Attendance == Convert.ToDecimal(1.0))
                                            {
                                                total_atthours.Add(Convert.ToDecimal(_newobj.Attendance));
                                            }

                                        }
                                        @*@finalworkinghours= @total_atthours.Sum();*@

                                        @if (leavemst > 0)
                                        {
                                            foreach (Leave_Master _l in _leave.Where(x => x.User_Id == _um.User_ID))
                                            {
                                                //if (_l.User_Id == _um.User_ID)
                                                //{
                                                if (_l.Leave_Type != "LWPS")
                                                {
                                                    count = Convert.ToDecimal(count + _l.leave_days);
                                                    n = Convert.ToDecimal(total_atthours.Sum() + count);

                                                }
                                                else
                                                {

                                                    //n = Convert.ToDecimal(holidays + sundays);
                                                    n = Convert.ToDecimal(total_atthours.Sum());

                                                }
                                                //}
                                                //else
                                                //{

                                                //    //n = Convert.ToDecimal(holidays + sundays);
                                                //}
                                                Absent = Convert.ToDecimal(Workingdays - n) + absent_leave;
                                            }

                                        }
                                        else
                                        {
                                            n = Convert.ToDecimal(total_atthours.Sum());
                                            Absent = Convert.ToDecimal(Workingdays) - total_atthours.Sum();
                                        }
                                        <td>@ViewBag.WorkingDays </td>
                                        <td>@n</td>
                                        <td>@Absent</td>

                                        <td>
                                            <a href="~/Access/Attendance_history?User_Id=@_um.User_ID&Year=@ViewBag.Year&Month=@ViewBag.Month" data-toggle="tooltip" data-placement="top" title="View"><b><i class="fa fa-eye fa-2x text-primary"></i></b></a>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }

            </div>
        </div>
    </div>
</div>


<!-- End Row-->

<script type="text/javascript">
    function onDownload() {
        const fromDate = document.getElementById("datepicker").value;
        window.location.href = `/Access/ExportAllUserPunchToCsv?fromDate=${fromDate}`;
    }
    $("#datepicker").datepicker({
        format: "mm-yyyy",
        startView: "months",
        minViewMode: "months"
    });
</script>
